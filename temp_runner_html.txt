  // ===========================================================================
  // OPTIMIZED RUNNER HTML
  // Loads dependencies once, then listens for code updates via postMessage
  // ===========================================================================
  const runnerHtml = useMemo(() => `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            zinc: { 950: '#09090b', 900: '#18181b', 800: '#27272a', 700: '#3f3f46', 600: '#52525b', 500: '#71717a', 400: '#a1a1aa', 300: '#d4d4d8', 200: '#e4e4e7', 100: '#f4f4f5' }
          }
        }
      }
    }
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body, #root { min-height: 100%; width: 100%; }
    body { background: #09090b; font-family: "Inter", system-ui, sans-serif; color: #fff; }
    .preview-loading { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(180deg, #09090b 0%, #18181b 100%); }
    .preview-loading-spinner { width: 32px; height: 32px; border: 2px solid #27272a; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .preview-loading-text { margin-top: 16px; color: #71717a; font-size: 13px; letter-spacing: 0.01em; }
    .error { color: #ef4444; padding: 2rem; font-family: monospace; white-space: pre-wrap; background: #18181b; line-height: 1.6; }
    .error h2 { color: #fecaca; margin-bottom: 1rem; font-size: 1rem; font-weight: bold; }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #18181b; }
    ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #52525b; }
  </style>
</head>
<body>
  <div id="root">
    <div class="preview-loading">
      <div class="preview-loading-spinner"></div>
      <div class="preview-loading-text">Initializing environment...</div>
    </div>
  </div>

  <!-- Dependencies -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/framer-motion@11/dist/framer-motion.js"></script>
  <script src="https://unpkg.com/lucide-react@0.294.0/dist/umd/lucide-react.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script>
    // Setup Globals
    window.React = React;
    window.ReactDOM = ReactDOM;
    
    // Motion & Lucide Globals
    window.motion = window.Motion?.motion || { div: "div", button: "button", a: "a", span: "span", p: "p", h1: "h1", h2: "h2", h3: "h3", section: "section", main: "main", nav: "nav", ul: "ul", li: "li", img: "img", input: "input", form: "form", label: "label", textarea: "textarea" };
    window.AnimatePresence = window.Motion?.AnimatePresence || function(props) { return props.children; };
    window.useAnimation = window.Motion?.useAnimation || function() { return {}; };
    window.useInView = window.Motion?.useInView || function() { return true; };
    window.useScroll = window.Motion?.useScroll || function() { return { scrollY: 0, scrollYProgress: 0 }; };
    window.useTransform = window.Motion?.useTransform || function(v) { return v; };
    window.useSpring = window.Motion?.useSpring || function(v) { return v; };
    window.useMotionValue = window.Motion?.useMotionValue || function(v) { return { get: function() { return v; }, set: function() {} }; };
    
    window.LucideIcons = window.lucideReact || {};
    if (!window.LucideIcons || Object.keys(window.LucideIcons).length === 0) {
      window.LucideIcons = new Proxy({}, { get: function() { return function() { return null; }; } });
    }

    // Theme Config
    const themeConfig = \`
      const colors = {
        cyan: { primary: '#00A5C7', bright: '#00D4FF', light: 'rgba(0, 165, 199, 0.08)' },
        background: { light: '#FAFAFC', white: '#FFFFFF', dark: '#0A0A0A', darker: '#0F0F0F' },
        text: { primary: '#0E0E0E', secondary: '#606260', tertiary: '#949797', light: '#C0C8D0', lighter: '#D8DCE0', white: '#FAFAFC' },
        border: { light: '#EBEBEF', cyan: 'rgba(0, 212, 255, 0.2)', default: '#DADADA' },
      };
      const spacing = { section: { py: 'py-16 md:py-24', px: 'px-8' } };
      const typography = {
        eyebrow: { fontSize: '0.813rem', letterSpacing: '0.15em', textTransform: 'uppercase', fontWeight: 500 },
        hero: { fontSize: 'clamp(3rem, 7vw, 5.5rem)', lineHeight: '1.1', letterSpacing: '-0.03em', fontWeight: 300 },
        h2: { fontSize: 'clamp(2rem, 4vw, 2.75rem)', fontWeight: 300, lineHeight: '1.2' },
        h3: { fontSize: '1.25rem', fontWeight: 400 },
        body: { fontSize: '1rem', lineHeight: '1.7' },
        bodyLarge: { fontSize: 'clamp(1.25rem, 2.5vw, 1.75rem)', lineHeight: '1.5' },
      };
      const effects = {
        glass: { backgroundColor: 'rgba(255, 255, 255, 0.04)', border: '1px solid rgba(0, 212, 255, 0.2)', backdropFilter: 'blur(10px)', boxShadow: '0 8px 32px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.05)' },
        glassLight: { backgroundColor: 'rgba(255, 255, 255, 0.05)', border: '1px solid #00A5C7', backdropFilter: 'blur(10px)', boxShadow: 'inset 0 1px 0 rgba(255, 255, 255, 0.1)' },
        cardBorder: { backgroundColor: '#FFFFFF', border: '1px solid #EBEBEF' },
      };
    \`;

    // Router Component
    let pageRegistry = {};
    
    const Router = () => {
      const [currentPath, setCurrentPath] = React.useState(window.location.hash.slice(1) || '/');
      
      React.useEffect(() => {
        const handleHashChange = () => setCurrentPath(window.location.hash.slice(1) || '/');
        window.addEventListener('hashchange', handleHashChange);
        return () => window.removeEventListener('hashchange', handleHashChange);
      }, []);

      // Find component
      const PageComponent = pageRegistry[currentPath] || pageRegistry['/'];
      
      if (!PageComponent) {
        return React.createElement('div', { className: 'flex items-center justify-center h-screen text-zinc-500' }, 'Page not found: ' + currentPath);
      }
      
      return React.createElement(PageComponent);
    };

    // Message Handler
    window.addEventListener('message', (event) => {
      if (!event.data || event.data.type !== 'UPDATE') return;
      
      const { pages, currentPageId } = event.data;
      
      try {
        const newRegistry = {};
        
        // Common imports for all pages
        const commonImports = \`
          const { useState, useEffect, useMemo, useCallback, useRef } = React;
          const motion = window.motion;
          const AnimatePresence = window.AnimatePresence;
          const LucideIcons = window.LucideIcons;
          const { ArrowRight, ArrowLeft, ArrowUp, ArrowDown, Check, CheckCircle, CheckCircle2, Circle, X, Menu, ChevronDown, ChevronUp, ChevronLeft, ChevronRight, Plus, Minus, Search, Settings, User, Users, Mail, Phone, MapPin, Calendar, Clock, Star, Heart, Home, Globe, Layers, Lock, Award, BookOpen, Zap, Shield, Target, TrendingUp, BarChart, PieChart, Activity, Eye, EyeOff, Edit, Trash, Copy, Download, Upload, Share, Link, ExternalLink, Send, MessageCircle, Bell, AlertCircle, Info, HelpCircle, Loader, RefreshCw, RotateCcw, Save, FileText, Folder, Image, Play, Pause, SkipBack, SkipForward, Volume2, VolumeX, Mic, Video, Camera, Wifi, Battery, Sun, Moon, Cloud, Droplet, Wind, Thermometer, MapIcon, Navigation: NavIcon, Compass, Flag, Bookmark, Tag, Hash, AtSign, Filter, Grid, List, LayoutGrid, Maximize, Minimize, Move, Crop, ZoomIn, ZoomOut, MoreHorizontal, MoreVertical, Briefcase, Building, Cpu, Database, Server, Code, Terminal, GitBranch, Github, Linkedin, Twitter, Facebook, Instagram, Youtube } = LucideIcons;
          \${themeConfig}
        \`;

        pages.forEach(page => {
          // Compile with Babel
          const fullCode = commonImports + '\\n' + page.cleanedCode + '\\n return ' + page.componentName + ';';
          
          const transpiled = Babel.transform(fullCode, { 
            presets: ['react', 'env'],
            filename: page.path + '.tsx'
          }).code;
          
          // Execute
          const component = new Function(transpiled)();
          newRegistry[page.path] = component;
        });
        
        pageRegistry = newRegistry;
        
        // Set initial route if provided
        if (currentPageId) {
          const targetPage = pages.find(p => p.id === currentPageId);
          if (targetPage && targetPage.path) {
             window.location.hash = targetPage.path === '/' ? '' : targetPage.path;
          }
        }
        
        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(Router));
        
      } catch (err) {
        console.error('Preview Render Error:', err);
        window.parent.postMessage({ type: 'preview-error', message: err.message }, '*');
        document.getElementById('root').innerHTML = \`<div class="error"><h2>Render Error</h2><p>\${err.message}</p></div>\`;
      }
    });

    // Signal ready
    window.parent.postMessage({ type: 'preview-ready' }, '*');
  </script>
</body>
</html>`, [])

  // Send code updates to iframe
  useEffect(() => {
    if (!iframeRef.current?.contentWindow || !iframeLoaded) return;

    // Prepare pages payload
    const pagesToRender = (pages && pages.length > 0) ? pages : (code ? [{ id: 'single', path: '/', code, name: 'Home' }] : []);
    
    if (pagesToRender.length === 0) return;

    const processedPages = pagesToRender.map((page, idx) => {
      const regex = /(?:function|const|let|var)\s+([A-Z][a-zA-Z0-9]*)(?:\s*[=:(]|\s*:)/g
      const matches = [...page.code.matchAll(regex)]
      const componentName = matches.length > 0 ? matches[0][1] : \`Page\${idx}\`

      const cleanedCode = page.code
        .replace(/import\s*\{[^}]*\}\s*from\s*['"](?:motion\/react|framer-motion|motion)['"]\s*;?/g, '')
        .replace(/import\s*\{[^}]*\}\s*from\s*['"]lucide-react['"]\s*;?/g, '')
        .replace(/import\s*\{[^}]*\}\s*from\s*['"]react['"]\s*;?/g, '')
        .replace(/import\s+\w+\s*from\s*['"][^'"]+['"]\s*;?/g, '')
        .replace(/import\s*['"][^'"]+['"]\s*;?/g, '')
        .replace(/interface\s+\w+\s*\{[\s\S]*?\}/g, '')
        .replace(/type\s+\w+\s*=[^;]+;/g, '')
        .replace(/\s+as\s+[A-Za-z][A-Za-z0-9\[\]<>|&\s,'_]*/g, '')
        .replace(/(useState|useRef|useMemo|useCallback|useEffect)<[^>]+>/g, '$1')
        .replace(/:\s*(React\.)?FC(<[^>]*>)?/g, '')
        .replace(/:\s*[A-Z][A-Za-z0-9\[\]<>|&\s,']*(?=\s*=\s*[\[{(])/g, '')
        .replace(/(\(\s*\w+):\s*(?:keyof\s+|typeof\s+|readonly\s+)?[A-Z][^,)]*(?=[,)])/g, '$1')
        .replace(/,(\s*\w+):\s*(?:keyof\s+|typeof\s+|readonly\s+)?[A-Z][^,)]*(?=[,)])/g, ',$1')
        .replace(/(\(\s*\w+):\s*(?:string|number|boolean|any|void|never|unknown)(?:\[\])?(?=[,)])/g, '$1')
        .replace(/,(\s*\w+):\s*(?:string|number|boolean|any|void|never|unknown)(?:\[\])?(?=[,)])/g, ',$1')
        .replace(/\):\s*[A-Za-z][A-Za-z0-9\[\]<>|&\s,']*(?=\s*[{=])/g, ')')
        .replace(/export\s+default\s+/g, '')
        .replace(/export\s+/g, '')
        .replace(/React\.useState/g, 'useState')
        .replace(/React\.useEffect/g, 'useEffect')
        .replace(/React\.useMemo/g, 'useMemo')
        .replace(/React\.useCallback/g, 'useCallback')
        .replace(/React\.useRef/g, 'useRef')
        .replace(/'use client'\s*;?/g, '')
        .replace(/"use client"\s*;?/g, '')
        .replace(/:\s*React\.\w+(?:Event|Handler)(?:<[^>]+>)?/g, '')
        .replace(/:\s*(?:Form|Mouse|Keyboard|Change|Focus|Touch|Input|Submit|Click)Event(?:<[^>]+>)?/g, '')
        .replace(/:\s*(?:Event|SyntheticEvent)(?:<[^>]+>)?/g, '');

      return {
        id: page.id,
        path: page.path,
        componentName,
        cleanedCode
      };
    });

    iframeRef.current.contentWindow.postMessage({
      type: 'UPDATE',
      pages: processedPages,
      currentPageId
    }, '*');

  }, [code, pages, currentPageId, iframeLoaded]);
